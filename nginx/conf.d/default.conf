# nginx/conf.d/default.conf
server {
    # 80番ポートで待ち受ける（httpのデフォルトポート）
    listen 80;
    # IPv6でも待ち受ける
    listen [::]:80;

    # どのドメイン名で受け付けるか（localhostで動作確認）
    server_name localhost;

    # Laravelのpublicディレクトリをドキュメントルートに指定
    root /var/www/html/public;

    # セキュリティヘッダー
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    # デフォルトのインデックスファイル．Laravelでは index.php がエントリポイント
    index index.php;

    # レスポンス文字コード
    charset utf-8;

    # ルートパス（/）にアクセスした時の動作
    location / {
      # 静的ファイルがある場合はそれを返し，
      # なければ Laravel の index.php に処理を渡す（フロントコントローラ方式）
      try_files $uri $uri/ /index.php?$query_string;
    }

    # favicon と robots.txt のログは不要
    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # 404 も Laravel に処理させる
    error_page 404 /index.php;

    # ---------------------------
    # PHP ファイルの処理
    # ---------------------------
    location ~ \.php$ {
        # Docker では php-fpm を動かしているコンテナ名:ポート番号を指定
        fastcgi_pass api:9000;

        # SCRIPT_FILENAME を実際のファイルパスで渡す
        # $realpath_root は root の実パスに解決される
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;

        # fastcgi の基本パラメータを読み込む
        include fastcgi_params;
    }

    # ---------------------------
    # .env などの隠しファイルはすべて拒否
    # ---------------------------
    location ~ /\.(?!well-known).* {
      deny all;
    }
}
